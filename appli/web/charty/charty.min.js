function generateColor(a,b){return b|=16777215,"#"+Math.floor((Math.abs(a)%16777215+b)/2).toString(16)}var charty={};charty.setDate=function(a,b){charty.from=a,charty.to=b},charty.setInstanceId=function(a){charty.instanceId=a},charty.URL=WEB_SERVICE_URL+"/graph",charty.GRAPH_PATH="/charty/objects/",charty.TEMPLATE_PATH="/charty/template/",charty.LAYOUT_PATH="/charty/layout/",charty.loadedScript=[],charty.objects=[],charty.loadProgress=0,charty.generateTemplate=function(b,c){function d(a){return $.ajax({async:!1,type:"GET",url:charty.TEMPLATE_PATH+a+".hbs",success:function(b){Handlebars.registerPartial(a,Handlebars.compile(b))}})}$.ajax({url:charty.LAYOUT_PATH+c+".json",async:!1,success:function(a){if(console.log(JSON.stringify(a)),templateId=a.id,partialName=a.template,$("#"+templateId).length)return void console.log("try to load graph multiple time");$.inArray(partialName,Handlebars.partials)&&d(partialName),template=Handlebars.compile("{{>"+partialName+" }}"),graphLayoutArray=a.graph,$("#"+b).append(template(a)),$.each(graphLayoutArray,function(a,b){graphId=templateId+"-"+a,charty.objects[graphId]=charty.create(graphId,b)})}})},charty.limitData=function(a,b){for(key in a){tmpDataArray=[];for(subKey in a[key])tmpDataArray.push({key:subKey,value:a[key][subKey]});tmpDataArray.sort(function(a,b){return b.value-a.value}),tmpData={},other=0;for(i in tmpDataArray)i<b?tmpData[tmpDataArray[i].key]=tmpDataArray[i].value:other+=tmpDataArray[i].value;other>0&&(tmpData.other=other),a[key]=tmpData}},charty.reformatData=function(a){dataToReturn=[];for(key in a)if(value=a[key],1==a[key].length||1==Object.keys(a[key]).length)elementKey=Object.keys(a[key])[0],element=value[elementKey],!1===Array.isArray(element)&&(element=[element]),element.unshift(elementKey),dataToReturn.push(element);else for(elementName in a[key])!1===Array.isArray(a[key][elementName])?dataToReturn.push([elementName,value[elementName]]):(dataToReturn[key+"."+elementName]=value[elementName],dataToReturn[key+"."+elementName].unshift(key+"."+elementName));return dataToReturn},charty.gatherDataFromLayout=function(a,b){returnedData={},console.log(b);for(gatherType in b)for(className in b[gatherType])indicators=b[gatherType][className].indicators,jQuery.extend(returnedData,a[gatherType][className]);return returnedData},charty.create=function(a,b){switch(graphType=b.type,graphType){case"LineGraph":return new charty.LineGraph(a,b);case"PieChart":return new charty.PieChart(a,b);case"InformationTable":return new charty.InformationTable(a,b);case"Gauge":return new charty.Gauge(a,b)}},charty.Gauge=function(b,c){this.id=b,this.dataLayout=c.dataLayout||null,this.parameters=c.parameter||null,this.updateOnClick=c.updateOnClick||null,chartProperty={},$.ajax({url:charty.URL,type:"POST",context:this,async:!1,data:{layout:JSON.stringify({data:c.data,parameters:c.parameters}),from:charty.from,to:charty.to,instanceId:charty.instanceId,token:sessionStorage.getItem("token")},success:function(a){data={},data=charty.gatherDataFromLayout(a,c.data),data=charty.reformatData(data),console.log(data),console.log(chartProperty),this.chart=c3.generate(jQuery.extend(!0,{bindto:"#"+this.id,data:{columns:data,type:"gauge",onclick:function(a,d){if("other"!=a.id)for(i in c.updateOnClick)boundedElement=c.updateOnClick[i],b=a.id,color=$(d).css("fill"),(object=charty.objects[boundedElement])&&(colors={},colors[b]={},colors[b]=[color],object.update(b,{}))}},color:{pattern:["#FF0000","#ff8000","#cccc00","#269900"],threshold:{values:[7,13,17,16]}},gauge:{label:{format:function(a,b){return Math.round(a)}},min:0,max:20,unit:""}},chartProperty,c.graphProperty))}})},$.ajax({async:!1,type:"GET",url:"/charty/objects/informationTable/informationRow.hbs",success:function(a){Handlebars.registerPartial("informationRow",Handlebars.compile(a))}}),$.ajax({async:!1,type:"GET",url:"/charty/objects/informationTable/informationTable.hbs",success:function(a){Handlebars.registerPartial("informationTable",Handlebars.compile(a))}}),charty.InformationTable=function(a,b){this.id=a,this.tableTemplate=Handlebars.compile("{{> informationTable }}"),this.rowTemplate=Handlebars.compile("{{> informationRow }}"),this.indicators=[],this.dataLayout=b.dataLayout,this.parameters=b.parameter||null,$.ajax({url:charty.URL,context:this,async:!1,type:"POST",data:{layout:JSON.stringify({data:b.data,parameters:b.parameters}),from:charty.from,to:charty.to,instanceId:charty.instanceId,token:sessionStorage.getItem("token")},success:function(a){data=charty.gatherDataFromLayout(a,b.data),console.log(data),this.indicators=[];for(gatherType in b.data)for(classKey in b.data[gatherType])for(indicatorKey in b.data[gatherType][classKey].indicators)this.indicators.push(b.data[gatherType][classKey].indicators[indicatorKey]);templateData={},templateData.headRow=[],templateData.row={},templateData.headRow.push({title:"name"}),console.log(indicators);for(i in indicators)indicator=this.indicators[i],templateData.headRow.push({title:indicator});tmpData={};for(i in this.indicators){indicator=this.indicators[i];for(elementKey in data[indicator])elementKey in tmpData==!1&&(tmpData[elementKey]={}),element=data[indicator][elementKey],tmpData[elementKey][indicator]=element}for(elementKey in tmpData){templateData.row[elementKey]=[],templateData.row[elementKey].push({content:elementKey});for(i in this.indicators)indicator=indicators[i],indicator in tmpData[elementKey]?(value=tmpData[elementKey][indicator],$.isNumeric(value)&&(value=value.toFixed(1)),templateData.row[elementKey].push({content:value})):templateData.row[elementKey].push({content:"null"})}$("#"+this.id).append(this.tableTemplate(templateData))}}),this.update=function(a,c){re=new RegExp("(\\s|\\*|\\:)","g");var d=this.id+"-"+a.replace(re,"_");idSelector=$("#"+d),idSelector.length<=0?(parameters=this.parameter?this.parameter:{},parameters.name_filter=a,$.ajax({url:charty.URL,context:this,async:!1,data:{layout:JSON.stringify({data:this.dataLayout,parameters:parameters}),from:charty.from,to:charty.to,instanceId:charty.instanceId,token:sessionStorage.getItem("token")},success:function(a){data=charty.gatherDataFromLayout(a,this.dataLayout),b=this.dataLayout,templateData={},tmpData={};for(i in this.indicators){indicator=this.indicators[i];for(elementKey in data[indicator])elementKey in tmpData==!1&&(tmpData[elementKey]={}),element=data[indicator][elementKey],tmpData[elementKey][indicator]=element}for(elementKey in tmpData){templateData=[],templateData.push({content:elementKey});for(i in this.indicators)indicator=this.indicators[i],console.log(tmpData[elementKey]),indicator in tmpData[elementKey]?(value=tmpData[elementKey][indicator],$.isNumeric(value)&&(value=value.toFixed(1)),templateData.push({content:value})):templateData.push({content:"null"})}templateData.id=d,templateData.color=c.color,$("#"+this.id).find("tbody").append(this.rowTemplate(templateData))}})):idSelector.is(":visible")?idSelector.hide():0==idSelector.is(":visible")&&idSelector.show()}},charty.LineGraph=function(b,c){this.id=b,this.dataLayout=c.dataLayout||null,this.parameters=c.parameter||null,chartProperty={point:{show:!1},color:{pattern:[generateColor(hashCode(b))]},line:{label:{format:function(a,b,c){return c.split(".")[0]}}},axis:{x:{type:"timeseries",tick:{format:"%d-%m-%y %Hh%Mm",centered:!0,culling:{max:8},fit:!1},padding:{left:0,right:0}},y:{min:0,padding:{top:0,bottom:0}}}},$.ajax({url:charty.URL,context:this,async:!1,type:"POST",data:{layout:JSON.stringify({data:c.data,parameters:c.parameters}),from:charty.from,to:charty.to,instanceId:charty.instanceId,token:sessionStorage.getItem("token")},success:function(a){data=[],data=charty.gatherDataFromLayout(a,c.data),data=charty.reformatData(data),a.x.unshift("x"),data.push(a.x),this.chart=c3.generate(jQuery.extend(!0,{bindto:"#"+this.id,data:{columns:data,x:"x",xFormat:"%Y-%m-%d %H:%M:%S",type:"line",groups:[[],[],[]]}},chartProperty,c.graphProperty))}}),this._addData=function(a,b){this.chart.data(a).length>0?this.chart.data.shown([a]).length>0?this.chart.hide([a],{withLegend:!0}):this.chart.show([a],{withLegend:!0}):(parameters=this.parameter?this.parameter:{},parameters.name_filter=a,$.ajax({context:this,url:charty.URL,async:!1,data:{layout:JSON.stringify({data:this.dataLayout,parameters:parameters}),from:charty.from,to:charty.to,instanceId:charty.instanceId,token:sessionStorage.getItem("token")},dataType:"json",success:function(c){data=charty.gatherDataFromLayout(c,this.dataLayout),data=charty.reformatData(data),console.log(data),this.chart.load(jQuery.extend({columns:data,type:"area",hide:!0},b)),groups=this.chart.groups(),groups=this.chart.groups(),groups[1].push(a),this.chart.groups(groups)}}))},this.update=function(a,b,c){c=c||1,b=b||null,"chart"in this&&this.dataLayout?this._addData(a,b):c<=3&&setTimeout(function(){this.addData(a,b,c+1)},500),3==c&&console.log("addData has failed,chart isnt loaded or dataLayout is missing")}},hashCode=function(a){var b=0;if(0==a.length)return b;for(i=0;i<a.length;i++)char=a.charCodeAt(i),b=(b<<5)-b+char,b&=b;return b},charty.PieChart=function(b,c){this.id=b,this.dataLayout=c.dataLayout||null,this.parameters=c.parameter||null,this.updateOnClick=c.updateOnClick||null,chartProperty={},$.ajax({url:charty.URL,context:this,async:!1,type:"POST",data:{layout:JSON.stringify({data:c.data,parameters:c.parameters}),from:charty.from,to:charty.to,instanceId:charty.instanceId,token:sessionStorage.getItem("token")},success:function(a){if(data={},data=charty.gatherDataFromLayout(a,c.data),charty.limitData(data,c.limit),data=charty.reformatData(data),console.log(data),"generatedColor"in c){!0!==c.generatedColor?normalizer=c.generatedColor:normalizer=null,colors={};for(i in data)b=data[i][0],colors[b]=generateColor(hashCode(b),normalizer);colors.other="#D3D3D3",chartProperty={},chartProperty.data={},chartProperty.data.colors=colors}console.log(chartProperty),this.chart=c3.generate(jQuery.extend(!0,{bindto:"#"+this.id,data:{columns:data,type:"pie",order:null,groups:[[],[],[]],colors:{other:"#D3D3D3"},onclick:function(a,d){if("other"!=a.id)for(i in c.updateOnClick)boundedElement=c.updateOnClick[i],b=a.id,color=$(d).css("fill"),(object=charty.objects[boundedElement])&&(colors={},colors[b]={},colors[b]=[color],object.update(b,{colors:colors}))}}},chartProperty,c.graphProperty))}})};
